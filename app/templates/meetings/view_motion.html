{% extends 'base.html' %}
{% block content %}
<h1 class="font-bold text-bp-blue mb-4">{{ motion.title }}</h1>
<div class="bp-card bp-glow mb-4">{{ (motion.text_md or 'No motion text.')|markdown_to_html|safe }}</div>
<h3 class="font-bold mb-2">Amendments</h3>
<a href="{{ url_for('meetings.manage_conflicts', motion_id=motion.id) }}" class="bp-btn-secondary mb-4 inline-block">Manage Conflicts</a>
{% for amend in amendments %}
  <div class="bp-card mb-2">
    <p class="font-semibold mb-1">
      Proposed by {{ amend.proposer.name }} â€“
      {% if amend.seconder %}
        Seconded by {{ amend.seconder.name }}
      {% elif amend.board_seconded %}
        Board seconded
      {% else %}
        Not seconded
      {% endif %}
    </p>
    {{ amend.text_md|markdown_to_html|safe }}
    {% if amend.combined_from %}
    <p class="text-sm text-bp-grey-600 mt-2">Combined from: {{ ', '.join('A' ~ a.order for a in amend.combined_from) }}</p>
    {% endif %}
    {% set conf_list = [] %}
    {% for c in conflicts %}
      {% if c.amendment_a_id == amend.id %}{% set _ = conf_list.append('A' ~ c.amendment_b.order) %}{% endif %}
      {% if c.amendment_b_id == amend.id %}{% set _ = conf_list.append('A' ~ c.amendment_a.order) %}{% endif %}
    {% endfor %}
    {% if conf_list %}
    <p class="text-sm text-bp-grey-600">Conflicts with: {{ ', '.join(conf_list) }}</p>
    {% endif %}
    {% if amend.status %}
    <p class="text-sm text-bp-grey-600">Status: {{ amend.status }}</p>
    {% if amend.status in ['rejected', 'merged'] and amend.reason %}
    <p class="text-sm text-bp-grey-600">Reason: {{ amend.reason }}</p>
    {% endif %}
    {% endif %}
    <div class="mt-2 flex space-x-2">
      <a href="{{ url_for('meetings.edit_amendment', amendment_id=amend.id) }}" class="bp-btn-secondary">Edit</a>
      <form method="post" action="{{ url_for('meetings.delete_amendment', amendment_id=amend.id) }}">
        <button class="bp-btn-secondary">Delete</button>
      </form>
      {% if current_user.is_authenticated and current_user.has_permission('manage_meetings') %}
        {% if amend.status != 'rejected' %}
        <form method="post" action="{{ url_for('meetings.reject_amendment', amendment_id=amend.id) }}" class="flex space-x-2">
          <input type="text" name="reason" placeholder="Reason" class="border p-2 rounded" />
          <button class="bp-btn-secondary">Reject</button>
        </form>
        {% endif %}
        {% if amend.status != 'merged' %}
        <form method="post" action="{{ url_for('meetings.mark_amendment_merged', amendment_id=amend.id) }}" class="flex space-x-2">
          <input type="text" name="reason" placeholder="Reason" class="border p-2 rounded" />
          <button class="bp-btn-secondary">Mark merged</button>
        </form>
        {% endif %}
      {% endif %}
      {% if amend.status in ['rejected', 'merged'] %}
      <a href="{{ url_for('meetings.submit_objection', amendment_id=amend.id) }}" class="bp-btn-primary">Submit objection</a>
      {% endif %}
    </div>
  </div>
{% else %}
  <p>No amendments submitted.</p>
{% endfor %}

{% if current_user.is_authenticated and current_user.has_permission('manage_meetings') %}
  <div class="mt-4 space-x-2">
    {% if motion.withdrawal_requested_at %}
      <form method="post" action="{{ url_for('meetings.approve_motion_change', motion_id=motion.id, actor='chair') }}" class="inline-block">
        <button class="bp-btn-secondary">Chair Approve</button>
      </form>
      <form method="post" action="{{ url_for('meetings.approve_motion_change', motion_id=motion.id, actor='board') }}" class="inline-block">
        <button class="bp-btn-secondary">Board Approve</button>
      </form>
      <form method="post" action="{{ url_for('meetings.reject_motion_change', motion_id=motion.id) }}" class="inline-block">
        <button class="bp-btn-secondary">Reject</button>
      </form>
    {% else %}
      <a href="{{ url_for('meetings.request_motion_change', motion_id=motion.id) }}" class="bp-btn-primary">Request Withdrawal/Edit</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
