{% extends 'base.html' %}
{% from '_macros.html' import breadcrumbs %}
{% block content %}
{{ breadcrumbs([('Meetings', url_for('main.public_meetings')), (meeting.title, None)]) }}
<h1 class="font-bold text-bp-blue mb-2">{{ meeting.title }}</h1>
{% if meeting.summary_md %}
<div class="mb-4">{{ meeting.summary_md|markdown_to_html|safe }}</div>
{% endif %}

<p class="mb-2">Stage: {{ meeting.status or 'Draft' }} | Members: {{ member_count }}</p>
{% if meeting.notice_date %}
<p class="mb-4 text-sm text-bp-grey-700">Notice given {{ meeting.notice_date.strftime('%Y-%m-%d') }}</p>
{% endif %}
<button class="bp-btn-secondary mb-6" data-modal-target="resend-modal">Resend Voting Email</button>

{% if meeting.opens_at_stage1 and meeting.closes_at_stage1 %}
<p class="mb-2">
  Stage 1:
  {{ meeting.opens_at_stage1|format_dt }} –
  {{ meeting.closes_at_stage1|format_dt }}
  <a href="{{ stage1_ics_url }}" class="text-bp-blue hover:underline ml-2" download hx-boost="false">Add to calendar</a>
</p>
<div class="mb-4">
  <div id="stage1-progress" class="bp-progress" data-progress-open="{{ meeting.opens_at_stage1.isoformat() }}Z" data-progress-close="{{ meeting.closes_at_stage1.isoformat() }}Z" role="progressbar" aria-valuemin="0" aria-valuemax="100">
    <div class="bp-progress-bar"></div>
    <span class="sr-only"><span id="stage1-percent-text">{{ meeting.stage1_progress_percent() }}</span>% complete</span>
  </div>
  <span id="stage1-info" class="text-xs text-bp-grey-600 mt-1" role="status" aria-live="polite">
    <span id="stage1-countdown">{{ meeting.stage1_time_remaining() }}</span> left
  </span>
</div>
{% endif %}
{% if meeting.runoff_opens_at and meeting.runoff_closes_at %}
<p class="mb-2">
  Run-off:
  {{ meeting.runoff_opens_at|format_dt }} –
  {{ meeting.runoff_closes_at|format_dt }}
  <a href="{{ runoff_ics_url }}" class="text-bp-blue hover:underline ml-2" download hx-boost="false">Add to calendar</a>
</p>
{% endif %}
{% if meeting.opens_at_stage2 and meeting.closes_at_stage2 %}
<p class="mb-4">
  Stage 2:
  {{ meeting.opens_at_stage2|format_dt }} –
  {{ meeting.closes_at_stage2|format_dt }}
  <a href="{{ stage2_ics_url }}" class="text-bp-blue hover:underline ml-2" download hx-boost="false">Add to calendar</a>
</p>
<div class="mb-6">
  <div id="stage2-progress" class="bp-progress" data-progress-open="{{ meeting.opens_at_stage2.isoformat() }}Z" data-progress-close="{{ meeting.closes_at_stage2.isoformat() }}Z" role="progressbar" aria-valuemin="0" aria-valuemax="100">
    <div class="bp-progress-bar"></div>
    <span class="sr-only"><span id="stage2-percent-text">{{ meeting.stage2_progress_percent() }}</span>% complete</span>
  </div>
  <span id="stage2-info" class="text-xs text-bp-grey-600 mt-1" role="status" aria-live="polite">
    <span id="stage2-countdown">{{ meeting.stage2_time_remaining() }}</span> left
  </span>
</div>
{% endif %}
{% if files %}
<div class="mb-4">
  <h2 class="font-semibold mb-2">Documents</h2>
  <ul class="list-disc pl-5">
  {% for f in files %}
    <li class="mb-1">
      <a href="{{ url_for('main.public_meeting_file', meeting_id=meeting.id, file_id=f.id) }}" class="text-bp-blue hover:underline" download hx-boost="false">{{ f.title }}</a>
      {% if f.description %}<p class="text-sm text-bp-grey-700">{{ f.description }}</p>{% endif %}
    </li>
  {% endfor %}
  </ul>
</div>
{% endif %}
{% if amendments %}
<div class="mb-6" id="amendments-section">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-semibold">Published Amendments</h2>
    <button id="toggle-amendments" class="bp-btn-secondary bp-btn-sm">Expand all</button>
  </div>
  <div id="amendments-list" class="space-y-2">
  {% for amend in amendments %}
    <details class="border border-bp-grey-200 rounded-lg p-4 hover:bg-bp-grey-50 transition-colors">
      <summary class="font-semibold cursor-pointer">Amendment A{{ amend.order }}</summary>
      <div class="prose mt-2">{{ amend.text_md|markdown_to_html|safe }}</div>
    </details>
  {% endfor %}
  </div>
</div>
{% endif %}
{% if motions %}
<div class="mb-6" id="motions-section">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-semibold">Published Motions</h2>
    <button id="toggle-motions" class="bp-btn-secondary bp-btn-sm">Expand all</button>
  </div>
  <div id="motions-list" class="space-y-2">
  {% for motion in motions %}
    <details class="border border-bp-grey-200 rounded-lg p-4 hover:bg-bp-grey-50 transition-colors">
      <summary class="font-semibold cursor-pointer">{{ motion.title }}</summary>
      <div class="prose mt-2">{{ motion.text_md|markdown_to_html|safe }}</div>
    </details>
  {% endfor %}
  </div>
</div>
{% endif %}
<dialog id="resend-modal" class="bp-card w-full max-w-md" role="dialog" aria-labelledby="resend-title">
  <h2 id="resend-title" class="font-bold mb-2">Request Voting Email</h2>
  <div id="resend-modal-content" hx-target="this" hx-swap="outerHTML">
    {% include 'resend_modal_content.html' %}
  </div>
  <button class="bp-btn-secondary mt-4" data-close-modal>Close</button>
</dialog>
<script src="{{ url_for('static', filename='js/stage_progress.js') }}"></script>
<script src="{{ url_for('static', filename='js/accordion.js') }}"></script>
{% endblock %}
