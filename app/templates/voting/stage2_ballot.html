{% extends 'base.html' %}
{% from '_macros.html' import breadcrumbs %}
{% block content %}
{{ breadcrumbs([('Ballot', url_for('voting.ballot_home')), (meeting.title, None), ('Stage 2', None)]) }}
<h1 class="font-bold text-bp-blue mb-4">Stage 2 – Vote on Motion</h1>
{% set current_stage = 2 %}
{% include '_stepper.html' %}
{% if carried_summary %}
<div class="bp-card mb-4">{{ carried_summary|markdown_to_html|safe }}</div>
{% elif results_link %}
<div class="bp-card mb-4"><a href="{{ results_link }}" class="bp-link">View Stage 1 results summary</a></div>
{% endif %}
{% if preview %}
<div class="bp-alert-info text-center mb-4">Preview mode – votes will not be saved.</div>
{% endif %}
{% if proxy_for %}
<div class="bp-alert-warning text-center mb-4">
  Casting votes as proxy for {{ proxy_for.name }}.
</div>
{% endif %}
<form id="vote-form" method="post" class="bp-form bp-card space-y-4 pb-20">
  {{ form.hidden_tag() }}
  {% for motion, compiled in motions %}
    <blockquote class="bp-card bp-glow mb-4 whitespace-pre-line">{{ compiled|markdown_to_html|safe }}
      {% if not preview %}
      <a href="#" class="bp-link ml-2 text-sm" data-modal-target="comments-modal"
         hx-get="{{ url_for('comments.motion_comments', token=token, motion_id=motion.id) }}"
         hx-target="#comments-body" hx-trigger="click" hx-swap="innerHTML">Comments ({{ motion_counts[motion.id] }})</a>
      {% endif %}
    </blockquote>
    <div class="space-x-4 mb-4">
      {% for sub in form['motion_' ~ motion.id] %}
        <label class="inline-flex items-center mr-4">{{ sub() }}<span>{{ sub.label.text }}</span></label>
      {% endfor %}
    </div>
  {% endfor %}
  <dialog id="comments-modal" class="bp-card w-full max-w-lg" role="dialog" aria-labelledby="comments-title">
    <h2 id="comments-title" class="font-bold mb-2">Comments</h2>
    <div id="comments-body" class="mb-4"></div>
    <button class="bp-btn-secondary" data-close-modal>Close</button>
  </dialog>
  {% include 'voting/_sticky_footer.html' %}
</form>
<script src="{{ url_for('static', filename='js/voting_footer.js') }}"></script>
{% endblock %}
