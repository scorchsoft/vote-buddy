{% extends 'base.html' %}
{% block content %}
<h2 class="font-bold text-bp-blue mb-4">Returning Officer Dashboard</h2>
<div class="bp-card mb-4">
  <table class="bp-table">
    <thead class="bg-bp-grey-50">
      <tr>
        <th class="p-2 text-left">Meeting</th>
        <th class="p-2 text-left">Notice Date</th>
        <th class="p-2 text-left">Stage 1 Votes</th>
        <th class="p-2 text-left">Next Reminder</th>
        <th class="p-2 text-left">Quorum %</th>
        <th class="p-2 text-left">Time Remaining</th>
        <th class="p-2 text-left">Stage 1 Locked</th>
        <th class="p-2 text-left">Stage 2 Locked</th>
        <th class="p-2 text-left">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for meeting, count in meetings %}
      <tr class="border-t">
        <td class="p-2">{{ meeting.title }}</td>
        <td class="p-2">{{ meeting.notice_date.strftime('%Y-%m-%d') if meeting.notice_date else 'N/A' }}</td>
        <td class="p-2">{{ count }}/{{ meeting.quorum }}</td>
        <td class="p-2"><span class="bp-badge">{{ meeting.hours_until_next_reminder() or 2 }}h</span></td>
        <td class="p-2">{{ '%.1f'|format(meeting.quorum_percentage()) }}%</td>
        <td class="p-2">{{ meeting.stage1_time_remaining() }}</td>
        <td class="p-2">{{ 'Yes' if meeting.stage1_locked else 'No' }}</td>
        <td class="p-2">{{ 'Yes' if meeting.stage2_locked else 'No' }}</td>
        <td class="p-2 space-x-2">
          {% if meeting.stage1_locked %}
            <form action="{{ url_for('ro.unlock_stage', meeting_id=meeting.id, stage=1) }}" method="post" class="inline">
              {{ csrf_token() }}
              <button type="submit" class="bp-btn-primary text-sm">Unlock S1</button>
            </form>
          {% else %}
            <form action="{{ url_for('ro.lock_stage', meeting_id=meeting.id, stage=1) }}" method="post" class="inline">
              {{ csrf_token() }}
              <button type="submit" class="bp-btn-primary text-sm">Lock S1</button>
            </form>
          {% endif %}
          {% if meeting.stage2_locked %}
            <form action="{{ url_for('ro.unlock_stage', meeting_id=meeting.id, stage=2) }}" method="post" class="inline">
              {{ csrf_token() }}
              <button type="submit" class="bp-btn-primary text-sm">Unlock S2</button>
            </form>
          {% else %}
            <form action="{{ url_for('ro.lock_stage', meeting_id=meeting.id, stage=2) }}" method="post" class="inline">
              {{ csrf_token() }}
              <button type="submit" class="bp-btn-primary text-sm">Lock S2</button>
            </form>
          {% endif %}
          <a href="{{ url_for('ro.download_tallies', meeting_id=meeting.id) }}" class="bp-btn-secondary text-sm">CSV</a>
          <a href="{{ url_for('ro.download_stage2_tallies', meeting_id=meeting.id) }}" class="bp-btn-secondary text-sm">Stage 2 CSV</a>
          <a href="{{ url_for('ro.download_audit_log', meeting_id=meeting.id) }}" class="bp-btn-secondary text-sm">Audit</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7" class="p-2">No meetings.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
